<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Face Capture</title>
  <link rel="stylesheet" href="photo.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Poppins', sans-serif;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      background: transparent;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -3;
      animation: slider 30s infinite steps(1);
      background-size: cover;
      background-position: center;
      opacity: 0.2;
    }

    body::after {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.95) 0%, rgba(0, 0, 0, 0.7) 60%, rgba(0, 0, 0, 0.35) 100%);
      z-index: -2;
    }

    @keyframes slider {
      0%   { background-image: url('beautiful-nature-desktop-1920x1200-wallpaper-preview.jpg'); }
      10%  { background-image: url('depositphotos_311586652-stock-photo-beautiful-moraine-lake-banff-national.jpg'); }
      20%  { background-image: url('Beautiful-Wallpapers-Full-HD-Free-Download.jpg'); }
      30%  { background-image: url('photo-1506104489822-562ca25152fe.jpeg'); }
      40%  { background-image: url('drone-photography-forest.jpg'); }
      50%  { background-image: url('free-video-3121459.jpg'); }
      60%  { background-image: url('1280.jpeg'); }
      70%  { background-image: url('racing-f1-car-formula-1-race-car-hd-wallpaper-preview.jpg'); }
      80%  { background-image: url('1214059.png'); }
      90%  { background-image: url('3cd16960b795bd6bfc3c9a634987d90f.jpg'); }
      100% { background-image: url('ban-gioc-waterfall-in-china-and-vietnam-4k-wallpapers-hd-images-for-desktop-and-mobile-3840√ó2400-wallpaper-preview.jpg'); }
    }

    h2 {
      font-size: 32px;
      color: #ffffff;
      margin-bottom: 40px;
    }

    .form {
      background-color: #212121;
      border-radius: 25px;
      padding: 30px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      display: inline-block;
      z-index: 2;
    }

    label.wave-group {
      position: relative;
      margin: 0 0 40px;
      display: flex;
      justify-content: center;
      flex-direction: column;
      align-items: center;
      cursor: text;
    }

    .wave-group .input {
      font-size: 18px;
      padding: 10px 10px 10px 5px;
      display: block;
      width: 250px;
      border: none;
      border-bottom: 2px solid #515151;
      background: transparent;
      color: white;
      text-align: center;
    }

    .wave-group .input:focus {
      outline: none;
    }

    .wave-group .label {
      color: #999;
      font-size: 18px;
      font-weight: normal;
      position: absolute;
      pointer-events: none;
      left: 20px;
      transform: translateX(-20px);
      top: 10px;
      display: flex;
    }

    .wave-group .label-char {
      transition: 0.3s ease all;
      transition-delay: calc(var(--index) * .05s);
    }

    .wave-group .input:focus ~ .label .label-char,
    .wave-group .input:valid ~ .label .label-char {
      transform: translateY(-22px);
      font-size: 18px;
      color: #00ffd0;
    }

    .wave-group .bar {
      position: relative;
      display: block;
      width: 300px;
    }

    .wave-group .bar:before,
    .wave-group .bar:after {
      content: '';
      height: 2px;
      width: 0;
      bottom: 1px;
      position: absolute;
      background: #00ffd0;
      transition: 0.2s ease all;
    }

    .wave-group .bar:before {
      left: 50%;
    }

    .wave-group .bar:after {
      right: 50%;
    }

    .wave-group .input:focus ~ .bar:before,
    .wave-group .input:focus ~ .bar:after {
      width: 50%;
    }

    .btn2 {
      padding: 15px 25px;
      border: unset;
      border-radius: 15px;
      color: #e8e8e8;
      z-index: 1;
      background: #212121;
      position: relative;
      font-weight: 1000;
      font-size: 17px;
      margin: 20px;
      box-shadow: 4px 8px 19px -3px rgba(0,0,0,0.27);
      transition: all 250ms;
      overflow: hidden;
    }

    .btn2::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0;
      border-radius: 15px;
      background-color: #e8e8e8;
      z-index: -1;
      transition: all 250ms;
    }

    .btn2:hover {
      color: #212121;
    }

    .btn2:hover::before {
      width: 100%;
    }

    #video {
      display: none;
      border-radius: 10px;
      border: 3px solid #00ffd0;
      width: 600px;
      max-width: 90%;
      margin-top: 30px;
      box-shadow: 0 8px 20px rgba(0, 255, 208, 0.2);
    }

    .captured-images {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }

    .captured-container {
      position: relative;
      display: inline-block;
      margin: 10px;
    }

    .captured-container img {
      border: 2px solid #00ffd0;
      width: 200px;
      border-radius: 8px;
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
    }

    .delete-btn {
      position: absolute;
      top: -12px;
      right: -12px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-size: 16px;
    }

    .toast {
      position: fixed;
      top: 30px;
      right: 30px;
      background: #00ffd0;
      color: #121212;
      padding: 14px 24px;
      border-radius: 10px;
      box-shadow: 0 0 12px rgba(0,0,0,0.5);
      font-weight: bold;
      font-size: 16px;
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .toast.show {
      opacity: 1;
    }

    .btn3 {
      padding: 15px 30px;
      border: 2px solid #00ffd0;
      color: #00ffd0;
      background: transparent;
      text-transform: uppercase;
      font-weight: 600;
      font-size: 18px;
      border-radius: 8px;
      margin: 10px;
      cursor: pointer;
      transition: 0.3s;
    }

    .btn3:hover {
      background: #00ffd0;
      color: #121212;
    }

.loader {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 10px;
  z-index: 9999;
}

.loading-text {
  color: white;
  font-size: 16pt;
  font-weight: 600;
}

.dot {
  margin-left: 3px;
  animation: blink 1.5s infinite;
}
.dot:nth-child(2) {
  animation-delay: 0.3s;
}
.dot:nth-child(3) {
  animation-delay: 0.6s;
}

.loading-bar-background {
  --height: 30px;
  display: flex;
  align-items: center;
  box-sizing: border-box;
  padding: 5px;
  width: 200px;
  height: var(--height);
  background-color: #212121;
  box-shadow: #0c0c0c -2px 2px 4px 0px inset;
  border-radius: calc(var(--height) / 2);
}

.loading-bar {
  position: relative;
  display: flex;
  justify-content: center;
  flex-direction: column;
  --height: 20px;
  width: 0%;
  height: var(--height);
  overflow: hidden;
  background: linear-gradient(
    0deg,
    rgb(0, 200, 100) 0%,
    rgb(120, 255, 120) 100%
  );
  border-radius: calc(var(--height) / 2);
  animation: loading 4s ease-out infinite;
}

.white-bars-container {
  position: absolute;
  display: flex;
  align-items: center;
  gap: 18px;
}

.white-bar {
  background: linear-gradient(
    -45deg,
    rgba(255, 255, 255, 1) 0%,
    rgba(255, 255, 255, 0) 70%
  );
  width: 10px;
  height: 45px;
  opacity: 0.3;
  transform: rotate(45deg);
}

@keyframes loading {
  0% {
    width: 0;
  }
  80% {
    width: 100%;
  }
  100% {
    width: 100%;
  }
}

@keyframes blink {
  0%, 100% {
    opacity: 0;
  }
  50% {
    opacity: 1;
  }
}

    @media (max-width: 768px) {
      .form { width: 90%; padding: 20px; }
      .wave-group .input, .wave-group .bar { width: 90%; }
      #video { width: 95%; }
      .btn2, .btn3 { width: 90%; font-size: 16px; padding: 12px 20px; }
      .captured-container img { width: 140px; }
      .toast { right: 10px; left: 10px; font-size: 14px; width: auto; }
    }


.download-btn {
  margin-bottom: 8px;
  padding: 6px 14px;
  background-color: #28a745;
  color: white;
  text-decoration: none;
  font-size: 14px;
  border-radius: 5px;
  transition: background 0.3s;
}

.download-btn:hover {
  background-color: #218838;
}


    .image-grid {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .image-container {
    position: relative;
    max-width: 100%;
    border: 2px solid transparent;
    transition: border 0.3s ease;
  }

  .image-container.selected {
    border: 2px solid #007BFF;
  }

  .image-container img {
    width: 100%;
    height: auto;
    max-width: 300px;
    display: block;
  }

  img.selected {
  outline: 3px solid #00f;
  opacity: 0.8;
}

  </style>
</head>
<body>

<div id="formSection">
  <h2>Upload Your Face</h2>
  <form id="mainForm" class="form">
    <label class="wave-group">
      <input required name="name" type="text" class="input">
      <span class="bar"></span>
      <span class="label">
        <span class="label-char" style="--index: 0">N</span>
        <span class="label-char" style="--index: 1">a</span>
        <span class="label-char" style="--index: 2">m</span>
        <span class="label-char" style="--index: 3">e</span>
      </span>
    </label>
    <button id="startCam" type="button" class="btn2">Start Camera</button>
    <button type="submit" class="btn2">Submit</button>
  </form>
  <div class="captured-images" id="formCapturedImages"></div>
</div>

<div id="cameraSection" style="display:none;">
  <video id="video" autoplay muted playsinline></video>
  <div id="camControls">
    <button id="captureBtn" type="button" class="btn3">Capture</button>
    <button id="stopCam" type="button" class="btn3">Close Camera</button>
  </div>
  <div class="captured-images" id="capturedImages"></div>
</div>

<!-- Loader from Uiverse.io, customized -->
<div class="loader" id="loader" style="display: none;">
  <div class="loading-text">
    Loading<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span>
  </div>
  <div class="loading-bar-background">
    <div class="loading-bar">
      <div class="white-bars-container">
        <div class="white-bar"></div>
        <div class="white-bar"></div>
        <div class="white-bar"></div>
        <div class="white-bar"></div>
        <div class="white-bar"></div>
        <div class="white-bar"></div>
        <div class="white-bar"></div>
        <div class="white-bar"></div>
        <div class="white-bar"></div>
        <div class="white-bar"></div>
      </div>
    </div>
  </div>
</div>

<section id="imageSection" style="display: none;">
  <div style="margin-bottom: 10px;">
    <button class="btn2" id="selectAllBtn">Select All</button>
    <button class="btn2" id="deselectAllBtn">Deselect All</button>
    <button class="btn2" id="downloadAllBtn">Download Selected</button>
    <button class="btn2" id="doneBtn">Done</button>
  </div>
  <div id="imageContainer" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
</section>



<div class="toast" id="toast">Toast message</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const mainForm = document.getElementById("mainForm");
  const video = document.getElementById("video");
  const startBtn = document.getElementById("startCam");
  const stopBtn = document.getElementById("stopCam");
  const captureBtn = document.getElementById("captureBtn");
  const cameraSection = document.getElementById("cameraSection");
  const formSection = document.getElementById("formSection");
  const toast = document.getElementById("toast");
  const outputDiv = document.getElementById("capturedImages");
  const formCapturedImages = document.getElementById("formCapturedImages");
  const imageSection = document.getElementById("imageSection");
  const imageContainer = document.getElementById("imageContainer");
  const selectAllBtn = document.getElementById("selectAllBtn");
  const deselectAllBtn = document.getElementById("deselectAllBtn");
  const downloadAllBtn = document.getElementById("downloadAllBtn");
  const doneBtn = document.getElementById("doneBtn");
  const loader = document.getElementById("loader");

  let stream = null;
  let captureCount = 0;

  const capturePrompts = [
    "üì∏ Face front and click Capture.",
    "‚Ü©Ô∏è Turn left and click Capture.",
    "‚Ü™Ô∏è Turn right and click Capture."
  ];

  // === TOAST ===
  function showToast(message) {
    toast.textContent = message;
    toast.style.display = "block";
    setTimeout(() => {
      toast.style.display = "none";
    }, 3000);
  }

  // === CAMERA ===
  async function setupCamera() {
    try {
      showToast("üì∑ Starting camera...");
      stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      await video.play();

      video.style.display = "block";
      cameraSection.style.display = "block";
      formSection.style.display = "none";
      captureCount = 0;
      outputDiv.innerHTML = "";
      showToast(capturePrompts[captureCount]);
    } catch (err) {
      showToast("‚ùå Camera not accessible.");
      console.error(err);
    }
  }

  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }
    video.style.display = "none";
    cameraSection.style.display = "none";
    formSection.style.display = "block";

    formCapturedImages.innerHTML = outputDiv.innerHTML;
    outputDiv.innerHTML = "";

    formCapturedImages.querySelectorAll(".captured-container .delete-btn").forEach(btn => {
      btn.onclick = () => {
        btn.parentElement.remove();
        captureCount--;
        showToast("üóëÔ∏è Image removed.");
      };
    });

    showToast("üì¥ Camera stopped.");
  }

  // === CAPTURE ===
  function captureFace() {
    if (captureCount >= 3) {
      showToast("‚ö†Ô∏è Max 3 images allowed.");
      return;
    }

    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const img = new Image();
    img.src = canvas.toDataURL("image/png");

    const container = document.createElement("div");
    container.className = "captured-container";

    const deleteBtn = document.createElement("button");
    deleteBtn.className = "delete-btn";
    deleteBtn.textContent = "√ó";
    deleteBtn.onclick = () => {
      container.remove();
      captureCount--;
      showToast("üóëÔ∏è Image removed.");
    };

    container.appendChild(img);
    container.appendChild(deleteBtn);
    outputDiv.appendChild(container);

    captureCount++;
    if (captureCount < capturePrompts.length) {
      showToast(capturePrompts[captureCount]);
    } else {
      showToast("‚úÖ All captures done.");
    }
  }

  // === FORM SUBMIT ===
  mainForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = mainForm.querySelector('input[name="name"]').value.trim();
    const images = Array.from(formCapturedImages.querySelectorAll("img")).map(img => img.src);

    if (!name || images.length < 3) {
      showToast("‚ùó Name and 3 captures required.");
      return;
    }

    loader.style.display = "block";
    formSection.style.display = "none";

    try {
      const res = await fetch('http://127.0.0.1:5000/upload', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, images })
      });

      const result = await res.json();
      loader.style.display = "none";

      if (res.ok && result.matchedImages?.length) {
        showToast(`‚úÖ ${result.matchedImages.length} matches found!`);
        showResults(result.matchedImages);
      } else {
        showToast("‚ùå No matches found.");
        formSection.style.display = "block";
      }
    } catch (err) {
      console.error(err);
      showToast("‚ùå Server error.");
      loader.style.display = "none";
      formSection.style.display = "block";
    }
  });

  // === SHOW MATCHED IMAGES ===
   function showResults(images) {
  document.getElementById("imageSection").style.display = "block";
  imageSection.scrollIntoView({ behavior: "smooth" });
  imageContainer.innerHTML = "";

  images.forEach((src, i) => {
    const wrapper = document.createElement("div");
    wrapper.className = "image-wrapper";
    wrapper.style.position = "relative";
    wrapper.style.margin = "10px";
    wrapper.style.display = "inline-block";
    wrapper.style.border = "1px solid #ccc";
    wrapper.style.padding = "10px";
    wrapper.style.borderRadius = "10px";
    wrapper.style.textAlign = "center";
    wrapper.style.width = "200px";
    wrapper.style.backgroundColor = "#f9f9f9";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.className = "image-checkbox";
    checkbox.dataset.src = `/static/upload/${src}`;

    const img = document.createElement("img");
    img.src = `static/upload/${src}`;
    img.alt = `Matched Image ${i + 1}`;
    img.className = "result-image";
    img.style.width = "100%";
    img.style.borderRadius = "10px";
    img.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.2)";
    img.style.display = "block";
    img.style.cursor = "pointer";

    // üîΩ Download on image click
    img.addEventListener("click", () => {
      const link = document.createElement("a");
      link.href = img.src;
      link.download = src;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    const downloadBtn = document.createElement("a");
    downloadBtn.href = `http://localhost/photoweb/static/upload/${src}`; //A4.jpg
    downloadBtn.download = src;
    downloadBtn.textContent = "‚¨áÔ∏è Download";
    downloadBtn.className = "download-btn";

    // Styling
    downloadBtn.style.display = "block";
    downloadBtn.style.marginTop = "8px";
    downloadBtn.style.background = "#4CAF50";
    downloadBtn.style.color = "white";
    downloadBtn.style.padding = "6px 10px";
    downloadBtn.style.borderRadius = "6px";
    downloadBtn.style.textDecoration = "none";
    downloadBtn.style.fontSize = "14px";
    downloadBtn.style.cursor = "pointer";

    wrapper.appendChild(checkbox);
    wrapper.appendChild(img);
    wrapper.appendChild(downloadBtn);

    imageContainer.appendChild(wrapper);
  });
}



  // === IMAGE SELECTION CONTROLS ===
  selectAllBtn.onclick = () => {
    document.querySelectorAll(".image-checkbox").forEach(cb => cb.checked = true);
  };

  deselectAllBtn.onclick = () => {
    document.querySelectorAll(".image-checkbox").forEach(cb => cb.checked = false);
  };

  downloadAllBtn.onclick = async () => {
    const selected = document.querySelectorAll(".image-checkbox:checked");
    if (!selected.length) return showToast("‚ö†Ô∏è No images selected.");

    for (const cb of selected) {
      const url = cb.dataset.src;
      try {
        const res = await fetch(url);
        const blob = await res.blob();
        const objectUrl = URL.createObjectURL(blob);

        const link = document.createElement("a");
        link.href = objectUrl;
        link.download = url.split("/").pop();
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(objectUrl);
      } catch (err) {
        console.error("Error downloading:", url, err);
        showToast("‚ùå Error downloading one of the images.");
      }
    }
  };

  doneBtn.onclick = () => {
    window.location.reload();
  };

  // === BUTTON HANDLERS ===
  startBtn.onclick = setupCamera;
  stopBtn.onclick = stopCamera;
  captureBtn.onclick = captureFace;
});
</script>



</body>
</html>
